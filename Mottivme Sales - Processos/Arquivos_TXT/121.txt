# C√≥digo Python - 121.py

#!/usr/bin/env python3
"""
Script para limpar o √≠ndice Pinecone e reindexar com as corre√ß√µes.
"""

try:
    from pinecone import Pinecone  # type: ignore
except ImportError as e:
    print(f"Erro de importa√ß√£o: {e}")
    print("Certifique-se de que a biblioteca est√° instalada:")
    print("pip install pinecone")
    exit(1)

# Configura√ß√µes
PINECONE_API_KEY = "***REMOVED***"
INDEX_NAME = "quickstart"
NAMESPACE = "mottivme-docs"

def main():
    """Limpa o √≠ndice e executa reindexa√ß√£o."""
    print("üßπ Iniciando limpeza e reindexa√ß√£o...")
    
    # Inicializar Pinecone
    pc = Pinecone(api_key=PINECONE_API_KEY)
    index = pc.Index(INDEX_NAME)
    
    # 1. Verificar estado atual
    print("\nüìä Estado atual do √≠ndice:")
    stats = index.describe_index_stats()
    print(f"Total de vetores: {stats.total_vector_count}")
    print(f"Namespaces: {list(stats.namespaces.keys()) if stats.namespaces else ['default (vazio)']}")
    
    # 2. Limpar namespace padr√£o (onde est√£o os dados incorretos)
    print("\nüóëÔ∏è Limpando namespace padr√£o...")
    try:
        index.delete(delete_all=True, namespace="")  # namespace vazio = padr√£o
        print("‚úÖ Namespace padr√£o limpo!")
    except Exception as e:
        print(f"‚ö†Ô∏è Erro ao limpar namespace padr√£o: {e}")
    
    # 3. Limpar namespace mottivme-docs (caso tenha dados antigos)
    print(f"\nüóëÔ∏è Limpando namespace '{NAMESPACE}'...")
    try:
        index.delete(delete_all=True, namespace=NAMESPACE)
        print(f"‚úÖ Namespace '{NAMESPACE}' limpo!")
    except Exception as e:
        print(f"‚ö†Ô∏è Erro ao limpar namespace '{NAMESPACE}': {e}")
    
    # 4. Aguardar propaga√ß√£o
    print("\n‚è≥ Aguardando propaga√ß√£o da limpeza...")
    import time
    time.sleep(5)
    
    # 5. Verificar limpeza
    print("\nüìä Estado ap√≥s limpeza:")
    stats = index.describe_index_stats()
    print(f"Total de vetores: {stats.total_vector_count}")
    print(f"Namespaces: {list(stats.namespaces.keys()) if stats.namespaces else ['Nenhum']}")
    
    # 6. Executar reindexa√ß√£o
    print("\nüöÄ Iniciando reindexa√ß√£o com script corrigido...")
    import subprocess
    import sys
    
    try:
        result = subprocess.run([sys.executable, "indexar_arquivos_pinecone.py"], 
                              capture_output=True, text=True)
        print("üìù Sa√≠da da reindexa√ß√£o:")
        print(result.stdout)
        if result.stderr:
            print("‚ö†Ô∏è Erros:")
            print(result.stderr)
        
        if result.returncode == 0:
            print("‚úÖ Reindexa√ß√£o conclu√≠da com sucesso!")
        else:
            print(f"‚ùå Reindexa√ß√£o falhou com c√≥digo: {result.returncode}")
            
    except Exception as e:
        print(f"‚ùå Erro ao executar reindexa√ß√£o: {e}")
    
    # 7. Verificar resultado final
    print("\nüìä Estado final do √≠ndice:")
    stats = index.describe_index_stats()
    print(f"Total de vetores: {stats.total_vector_count}")
    if stats.namespaces:
        for ns, info in stats.namespaces.items():
            ns_name = ns if ns else "default (vazio)"
            print(f"  - {ns_name}: {info.vector_count} vetores")
    else:
        print("  - Nenhum namespace encontrado")

if __name__ == "__main__":
    main()