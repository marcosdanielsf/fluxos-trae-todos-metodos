# CÃ³digo Python - 117.py

#!/usr/bin/env python3
"""
DemonstraÃ§Ã£o do sistema de busca do CRM Socialfy indexado no Pinecone.
Este script mostra como realizar buscas semÃ¢nticas nos dados do Socialfy.
"""

import requests
import json
from typing import List, Dict, Any

# ConfiguraÃ§Ãµes
PINECONE_API_KEY = "***REMOVED***"
OPENAI_API_KEY = "***REMOVED***"
INDEX_NAME = "quickstart"
NAMESPACE = "mottivme-docs"

class SocialfySearch:
    """Classe para busca semÃ¢ntica no CRM Socialfy."""
    
    def __init__(self):
        self.pinecone_url = "https://quickstart-b11hvzz.svc.aped-4627-b74a.pinecone.io/query"
        self.openai_url = "https://api.openai.com/v1/embeddings"
        
    def get_embedding(self, text: str) -> List[float]:
        """Gera embedding usando OpenAI."""
        headers = {
            "Authorization": f"Bearer {OPENAI_API_KEY}",
            "Content-Type": "application/json"
        }
        
        data = {
            "input": text,
            "model": "text-embedding-ada-002"
        }
        
        response = requests.post(self.openai_url, headers=headers, json=data)
        
        if response.status_code == 200:
            return response.json()["data"][0]["embedding"]
        else:
            raise Exception(f"Erro ao gerar embedding: {response.status_code} - {response.text}")
    
    def search(self, query: str, top_k: int = 5) -> List[Dict[str, Any]]:
        """Realiza busca semÃ¢ntica no Pinecone."""
        # Gerar embedding da consulta
        query_embedding = self.get_embedding(query)
        
        headers = {
            "Api-Key": PINECONE_API_KEY,
            "Content-Type": "application/json"
        }
        
        data = {
            "vector": query_embedding,
            "topK": top_k,
            "includeMetadata": True,
            "namespace": NAMESPACE
        }
        
        response = requests.post(self.pinecone_url, headers=headers, json=data)
        
        if response.status_code == 200:
            results = response.json()
            return results.get("matches", [])
        else:
            raise Exception(f"Erro na busca: {response.status_code} - {response.text}")
    
    def format_results(self, results: List[Dict[str, Any]]) -> str:
        """Formata os resultados da busca."""
        if not results:
            return "âŒ Nenhum resultado encontrado."
        
        formatted = f"âœ… Encontrados {len(results)} resultados:\n\n"
        
        for i, match in enumerate(results, 1):
            score = match.get("score", 0)
            metadata = match.get("metadata", {})
            source = metadata.get("source", "N/A")
            text = metadata.get("text", "")
            
            formatted += f"ğŸ“„ **Resultado {i}** (RelevÃ¢ncia: {score:.1%})\n"
            formatted += f"ğŸ“ Arquivo: {source}\n"
            
            if text:
                # Mostrar um trecho relevante
                preview = text[:300] + "..." if len(text) > 300 else text
                formatted += f"ğŸ“– ConteÃºdo: {preview}\n"
            
            formatted += "\n" + "â”€" * 50 + "\n\n"
        
        return formatted

def demo_interactive():
    """DemonstraÃ§Ã£o interativa do sistema de busca."""
    search_engine = SocialfySearch()
    
    print("ğŸš€ Sistema de Busca CRM Socialfy")
    print("=" * 50)
    print("Digite suas perguntas sobre o CRM Socialfy.")
    print("Digite 'sair' para encerrar.\n")
    
    # Exemplos de consultas
    examples = [
        "O que Ã© o CRM Socialfy?",
        "Como funciona a automaÃ§Ã£o de WhatsApp?",
        "Quais sÃ£o os recursos de IA disponÃ­veis?",
        "Como funciona o modelo white label?",
        "Quais sÃ£o os preÃ§os e planos?",
        "Como integrar com a metodologia 5D?"
    ]
    
    print("ğŸ’¡ Exemplos de perguntas que vocÃª pode fazer:")
    for i, example in enumerate(examples, 1):
        print(f"   {i}. {example}")
    print()
    
    while True:
        try:
            query = input("ğŸ” Sua pergunta: ").strip()
            
            if query.lower() in ['sair', 'exit', 'quit']:
                print("ğŸ‘‹ AtÃ© logo!")
                break
            
            if not query:
                continue
            
            print(f"\nğŸ” Buscando por: '{query}'")
            print("â³ Processando...")
            
            results = search_engine.search(query, top_k=3)
            formatted_results = search_engine.format_results(results)
            
            print("\n" + formatted_results)
            
        except KeyboardInterrupt:
            print("\nğŸ‘‹ AtÃ© logo!")
            break
        except Exception as e:
            print(f"\nâŒ Erro: {e}")

def demo_predefined():
    """DemonstraÃ§Ã£o com consultas predefinidas."""
    search_engine = SocialfySearch()
    
    print("ğŸ¯ DemonstraÃ§Ã£o com Consultas Predefinidas")
    print("=" * 50)
    
    queries = [
        "Principais funcionalidades do CRM Socialfy",
        "Como funciona a integraÃ§Ã£o com WhatsApp",
        "Recursos de inteligÃªncia artificial",
        "Modelo de negÃ³cio white label SaaS",
        "AutomaÃ§Ã£o de workflows e processos"
    ]
    
    for i, query in enumerate(queries, 1):
        print(f"\nğŸ” Consulta {i}: {query}")
        print("â”€" * 40)
        
        try:
            results = search_engine.search(query, top_k=2)
            
            if results:
                for j, match in enumerate(results, 1):
                    score = match.get("score", 0)
                    metadata = match.get("metadata", {})
                    source = metadata.get("source", "N/A")
                    text = metadata.get("text", "")
                    
                    print(f"ğŸ“„ Resultado {j} (RelevÃ¢ncia: {score:.1%})")
                    print(f"ğŸ“ {source}")
                    
                    if text:
                        preview = text[:200] + "..." if len(text) > 200 else text
                        print(f"ğŸ“– {preview}")
                    print()
            else:
                print("âŒ Nenhum resultado encontrado")
                
        except Exception as e:
            print(f"âŒ Erro: {e}")

def main():
    """FunÃ§Ã£o principal."""
    print("ğŸŒŸ Bem-vindo ao Sistema de Busca CRM Socialfy!")
    print("Este sistema permite buscar informaÃ§Ãµes sobre o CRM Socialfy")
    print("usando busca semÃ¢ntica avanÃ§ada com IA.\n")
    
    while True:
        print("Escolha uma opÃ§Ã£o:")
        print("1. DemonstraÃ§Ã£o interativa")
        print("2. DemonstraÃ§Ã£o com consultas predefinidas")
        print("3. Sair")
        
        choice = input("\nSua escolha (1-3): ").strip()
        
        if choice == "1":
            demo_interactive()
        elif choice == "2":
            demo_predefined()
        elif choice == "3":
            print("ğŸ‘‹ AtÃ© logo!")
            break
        else:
            print("âŒ OpÃ§Ã£o invÃ¡lida. Tente novamente.")

if __name__ == "__main__":
    main()